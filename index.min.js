const Config={component:{tagName:"htmlium",attributeName:"loadcomponent",setTagName:"htmlium-set"},interpolation:{start:"{{",end:"}}",sanitize:!0},security:{sanitizeHtml:!0}},sanitize={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};import jsyaml from"https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.mjs";async function loadComponentsFromYaml(e="components.yaml"){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load components from ${e}`);const n=await t.text();return jsyaml.load(n)}class Processor{constructor(e={}){this.config=this.mergeConfig(e),this.regexCache=new Map,this.externalComponents={}}setExternalComponents(e){this.externalComponents=e||{}}mergeConfig(e){const t=JSON.parse(JSON.stringify(Config));return this.deepMerge(t,e),t}deepMerge(e,t){for(const n of Object.keys(t))t[n]&&"object"==typeof t[n]&&!Array.isArray(t[n])?(e[n]||(e[n]={}),this.deepMerge(e[n],t[n])):e[n]=t[n]}escRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}getRegex(e,t){return this.regexCache.has(e)||this.regexCache.set(e,t()),this.regexCache.get(e)}parseComponent(e){const{component:t}=this.config,n=this.getRegex("componentSet",(()=>new RegExp(`<${t.setTagName}\\s+([^>]+?)>([\\s\\S]*?)<\\/${t.setTagName}>`,"g"))),o={};let s=e,r=n.exec(e);for(;null!==r;){const t=this.parseAttributes(r[1]).component;t&&(o[t]=r[2]),r=n.exec(e)}return s=e.replace(new RegExp(`<${t.setTagName}[^>]*>[\\s\\S]*?<\\/${t.setTagName}>`,"g"),""),{components:o,html:s}}sanitizeText(e){return this.config.security.sanitizeHtml?e.replace(/[<>&"']/g,(e=>sanitize[e])):e}interpolate(e,t){const{interpolation:n}=this.config,o=this.getRegex("interpolation",(()=>new RegExp(`${this.escRegex(n.start)}(\\w+)${this.escRegex(n.end)}`,"g")));return e.replace(o,((e,o)=>{const s=t[o];return null==s?"":n.sanitize?this.sanitizeText(String(s)):String(s)}))}parseAttributes(e){const t={},n=/(\w+)="([^"]*)"/g;let o=n.exec(e);for(;null!==o;)t[o[1]]=o[2],o=n.exec(e);return t}transform(e){const{components:t,html:n}=this.parseComponent(e),o={...this.externalComponents,...t},{component:s}=this.config,r=this.getRegex("component",(()=>new RegExp(`<${s.tagName}\\s+([^>]+?)(?:\\/?)>`,"g")));return n.replace(r,((e,t)=>{const n=this.parseAttributes(t),r=n[s.attributeName];if(!r||!o[r])return"";const a={...n};delete a[s.attributeName];try{return this.interpolate(o[r],a)}catch{return""}}))}renderTo(e,t){const n=this.transform(e);return t&&(t.innerHTML=n),n}}function createProcessor(e={}){return new Processor(e)}async function processDocument(e={},t="components.yaml"){const n=createProcessor(e);try{const e=await loadComponentsFromYaml(t);n.setExternalComponents(e)}catch{console.warn(`Failed to load components from ${t}`)}const o=document.body.innerHTML,s=n.transform(o);document.body.innerHTML=s}document.addEventListener("DOMContentLoaded",(()=>{processDocument()}));export{Processor as process,createProcessor,processDocument};
